# 錯誤日誌：側邊欄重新命名失效 (狀態競爭與數據竄改)

## 1. 問題描述 (Issue)
使用者反映：在側邊欄對聊天室或群組進行重新命名時，若「點擊編輯 A 項目後，未完成輸入即點擊編輯 B 項目」，會發生以下異常：
1.  **介面卡死**: B 項目的編輯框瞬間出現後消失。
2.  **名稱誤改/無效**: A 項目的名稱被改成了 B 項目的舊名稱，或者完全沒有變化。

---

## 2. 根本原因分析 (Root Cause)
*   **狀態競爭 (State Race)**: `Sidebar.jsx` 使用單一的 `editingId` 與 `editingTitle` 管理全域編輯狀態。當切換編輯目標時，B 項目的 `onClick` (啟動編輯) 與 A 項目的 `onBlur` (送出並關閉編輯) 會幾乎同時發生。
*   **數據竄改**: 原本的 `onBlur` 使用了共用的 `editingTitle`。如果 B 項目的啟動邏輯先執行，它會把 `editingTitle` 設為 B 的名稱。接著 A 的 `onBlur` 才執行，就會把 A 的名稱儲存為 B 的內容，導致數據錯誤。
*   **狀態重置衝突**: `onBlur` 盲目呼叫 `setEditingId(null)`，這會覆蓋掉剛剛由 B 項目設定的新 ID，導致新的編輯框瞬間被關閉。

---

## 3. 解決方案 (Solution)
1.  **值捕捉 (Value Capture)**: 
    - 重構 `handleRenameSubmit`，使其直接接收傳入的 `value` 而非依賴共用狀態。
    - 在 `onBlur` 事件中，透過 `e.target.value` 取得當下輸入框的真實內容。
2.  **防禦性狀態重置 (Guarded Reset)**:
    - 調整 `setEditingId`，增加 `prev === id` 的判斷。
    - 只有在「當前編輯項目尚未切換」的情況下，才在提交後關閉編輯模式。
3.  **統一事件鏈**:
    - `Enter` 鍵現在直接呼叫提交函數並帶入當前值，不再依賴手動觸發 `blur()` 以避免複雜的事件循環。

---

## 4. 解決歷程 (Solution History)
1. **分析**: 利用 React 狀態追蹤邏輯，確認 `editingTitle` 在併發事件中的不穩定性。
2. **定位**: 確定為「共用狀態」與「非同步事件觸發順序」導致的連鎖反應。
3. **執行**: 修改 `Sidebar.jsx` 中的 `handleRenameSubmit` 簽名與事件掛載點。
4. **驗證**: 經本地邏輯推演，各別項目的 ID 與標題現已完全隔離，支持連續快速切換編輯。

---

## 5. 預防措施 (Prevention)
*   **局部狀態化**: 處理清單項目的編輯時，優先考慮使用元件內部的局部 State，而非提升到父元件共用。
*   **事件數據隔離**: 提交函數應盡可能透過參數（Props/Events）接收數據，而非直接從外層 Scope 抓取意圖性的 State。

---
**紀錄日期**: 2026-01-24  
**處理人員**: Antigravity (AI Assistant)
