# 錯誤日誌：輸入框失效與重複建立會話

## 1. 問題描述 (Issue)
1.  **全域輸入失效**: 修改後導所有的 `textarea` 與 `input` 都無法輸入文字，按鍵無反應。
2.  **重複初始會話**: 每次開啟 App 都會自動多出兩個 "New Chat"，導致側邊欄混亂。

---

## 2. 根本原因分析 (Root Cause)
*   **輸入失效**: 在嘗試隔離「重新命名」的點擊事件時，可能在 `App.jsx` 的狀態管理或事件冒泡處理中引入了錯誤的 `preventDefault()` 或條件渲染邏輯，導致輸入事件被攔截。
*   **重複會話**: 在 `useEffect` 的初始化邏輯中，同時呼叫了 `fetchSessions()` 與 `createNewSession()`，且 `fetchSessions` 可能在非同步過程中未及時偵測到已有會話，導致重複觸發建立邏輯。

---

## 3. 解決方案 (Solution)
1.  **修復輸入邏輯**: 簡化事件處理，移除不必要的 `onClick` 攔截，確保 React 正常處理受控組件 (Controlled Components)。
2.  **優化啟動流程**: 
    - 修改 `useEffect` 邏輯，先獲取現有會話。
    - 僅在資料庫完全為空時才建立第一個 "New Chat"。
    - 若已有會話，則預設載入最近的一個會話而非建立新的。

---

## 4. 解決歷程 (Solution History)
1. **觸發**: 實作聊天紀錄「重新命名」功能時，為了防止點擊輸入框觸發切換會話，加入了事件隔離邏輯。
2. **現象**: 側邊欄改好了，但主聊天視窗的輸入框發生鎖死，鍵盤輸入無效；且重複重整導致側邊欄出現多個空對話。
3. **診斷**: 
   - 核對 `App.jsx` 發現全域事件處理函式中存在錯誤的 `stopPropagation` 鏈結。
   - 初始化邏輯中 `fetchSessions` 與 `handleNewChat` 缺乏順序保障，產生競爭條件 (Race Condition)。
4. **修補**: 
   - 將點擊事件隔離限縮在側邊欄特定項次組件內，不再全域攔截。
   - 重構啟動邏輯為明確的流程：`await fetch` -> `檢查長度` -> `僅長度為0時 await create`。
5. **結果**: 輸入框功能恢復正常，且重複載入時資料庫狀態保持唯一穩定。

---

## 5. 預防措施 (Prevention)
*   **狀態分離**: 嚴格區分「聊天輸入」與「管理輸入」的 state，避免全域變數處理。
*   **啟動原子化**: 確保初始化邏輯具有排他性，不再盲目呼叫 POST 請求。

---
**紀錄日期**: 2026-01-22  
**處理人員**: Antigravity (AI Assistant)
